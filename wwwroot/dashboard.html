<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet" />

    <!-- Font Awesome untuk icons -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet" />

    <style>
      body {
        background-color: #f4f6f9;
      }
      .profile-container {
        max-width: 1000px;
        margin: 50px auto;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 30px;
      }
      .profile-header {
        text-align: center;
        margin-bottom: 30px;
      }
      .profile-avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #007bff;
      }
      .profile-info {
        margin-top: 20px;
      }
      .loading-spinner {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="profile-container">
        <!-- Loading Spinner -->
        <div class="text-center loading-spinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <!-- Profile Content -->
        <div id="profileContent" class="d-none">
          <div class="profile-header">
            <img
              id="profileAvatar"
              src="https://via.placeholder.com/150"
              alt="Profile Avatar"
              class="profile-avatar" />
            <h2 id="profileName" class="mt-3"></h2>
            <p id="profileEmail" class="text-muted"></p>
          </div>

          <!-- Employee Table Section -->
          <div class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h3>Employees</h3>
              <button id="createEmployeeBtn" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> Create Employee
              </button>
            </div>

            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>NIK</th>
                  <th>Name</th>
                  <th>Date of Birth</th>
                  <th>Gender</th>
                  <th>Address</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="employeeTableBody">
                <!-- Rows will be dynamically populated here -->
              </tbody>
            </table>
          </div>

          <div class="mt-4 text-center">
            <button id="logoutBtn" class="btn btn-danger">
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </div>

        <!-- Error Alert -->
        <div id="errorAlert" class="alert alert-danger d-none" role="alert">
          Unable to load profile. Please try again.
        </div>

        <!-- Employee Modal -->
        <div class="modal fade" id="employeeModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Create/Edit Employee</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="employeeForm">
                  <input type="hidden" id="employeeId" name="id" />
                  <input type="hidden" id="userId" name="userId" />
                  <!-- Tambahkan ini -->

                  <div class="mb-3">
                    <label for="nik" class="form-label">NIK</label>
                    <input
                      type="text"
                      class="form-control"
                      id="nik"
                      name="nik"
                      required />
                  </div>
                  <div class="mb-3">
                    <label for="name" class="form-label">Name</label>
                    <input
                      type="text"
                      class="form-control"
                      id="name"
                      name="name"
                      required />
                  </div>
                  <div class="mb-3">
                    <label for="tanggalLahir" class="form-label"
                      >Date of Birth</label
                    >
                    <input
                      type="date"
                      class="form-control"
                      id="tanggalLahir"
                      name="tanggalLahir"
                      required />
                  </div>
                  <div class="mb-3">
                    <label for="jenisKelamin" class="form-label">Gender</label>
                    <select
                      class="form-select"
                      id="jenisKelamin"
                      name="jenisKelamin"
                      required>
                      <option value="0">Male</option>
                      <option value="1">Female</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="alamat" class="form-label">Address</label>
                    <textarea
                      class="form-control"
                      id="alamat"
                      name="alamat"
                      required></textarea>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">
                  Cancel
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="saveEmployeeBtn">
                  Save
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to delete this employee?
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">
                  Cancel
                </button>
                <button
                  type="button"
                  class="btn btn-danger"
                  id="confirmDeleteBtn">
                  Delete
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      $(document).ready(function () {
        // Loading spinner
        $(".loading-spinner").show();

        // Create modal instances
        const employeeModal = new bootstrap.Modal(
          document.getElementById("employeeModal")
        );
        const deleteConfirmModal = new bootstrap.Modal(
          document.getElementById("deleteConfirmModal")
        );

        // Load Profile Function
        function loadProfile() {
          $.ajax({
            url: "/api/users/profile",
            method: "GET",
            xhrFields: { withCredentials: true },
            success: function (response) {
              const data = response.data;
              $(".loading-spinner").hide();
              $("#profileContent").removeClass("d-none");

              // Profile details
              $("#profileName").text(data.name);
              $("#profileEmail").text(data.email);
              $("#userId").val(data.id);

              // Load Employees
              loadEmployees(data.id);
            },
            error: function (xhr) {
              $(".loading-spinner").hide();
              $("#errorAlert").removeClass("d-none");

              if (xhr.status === 401) {
                window.location.href = "/login";
              }
            },
          });
        }

        // Load Employees Function
        function loadEmployees(userId) {
          $.ajax({
            url: `/api/karyawan/user/${userId}`,
            method: "GET",
            xhrFields: { withCredentials: true },
            success: function (response) {
              const tableBody = $("#employeeTableBody");
              tableBody.empty();

              response.data.forEach(function (employee) {
                const row = `
                        <tr>
                            <td>${employee.nik}</td>
                            <td>${employee.name}</td>
                            <td>${new Date(
                              employee.tanggalLahir
                            ).toLocaleDateString()}</td>
                            <td>${
                              employee.jenisKelamin === 0 ? "Male" : "Female"
                            }</td>
                            <td>${employee.alamat}</td>
                            <td>
                                <button class="btn btn-sm btn-info edit-employee" data-nik="${
                                  employee.nik
                                }">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-employee" data-nik="${
                                  employee.nik
                                }">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                tableBody.append(row);
              });
            },
            error: function (xhr) {
              console.error("Failed to load employees:", xhr);
              alert("Unable to load employees");
            },
          });
        }

        // Initial profile load
        loadProfile();

        // Create Employee Button Handler
        $("#createEmployeeBtn").on("click", function () {
          // Reset form
          $("#employeeForm")[0].reset();
          $("#employeeModal .modal-title").text("Create Employee");
          $("#nik").prop("disabled", false);
          employeeModal.show();
        });

        // Edit Employee Handler (Using Event Delegation)
        $(document).on("click", ".edit-employee", function () {
          const nik = $(this).data("nik");

          // Reset form
          $("#employeeForm")[0].reset();

          // Fetch employee details
          $.ajax({
            url: `/api/karyawan/${nik}`,
            method: "GET",
            xhrFields: { withCredentials: true },
            success: function (response) {
              const employee = response.data;
              console.log("Employee data:", employee);

              // Populate form
              $("#nik").val(employee.nik).prop("disabled", true);
              $("#name").val(employee.name);
              $("#tanggalLahir").val(
                new Date(employee.tanggalLahir).toISOString().split("T")[0]
              );
              $("#jenisKelamin").val(employee.jenisKelamin);
              $("#alamat").val(employee.alamat);

              // Set modal title
              $("#employeeModal .modal-title").text("Edit Employee");

              // Show modal
              employeeModal.show();
            },
            error: function (xhr) {
              console.error("Error fetching employee data:", xhr);
              alert("Failed to load employee data");
            },
          });
        });

        // Save Employee Handler
        $("#saveEmployeeBtn").on("click", function () {
          const userId = $("#userId").val();
          const nik = $("#nik").val();
          const isEditMode = $("#employeeModal .modal-title")
            .text()
            .includes("Edit");

          const formData = {
            nik: nik,
            name: $("#name").val(),
            tanggalLahir: $("#tanggalLahir").val(),
            jenisKelamin: parseInt($("#jenisKelamin").val()),
            alamat: $("#alamat").val(),
            negara: "Indonesia",
            userId: parseInt(userId),
          };

          const method = isEditMode ? "PUT" : "POST";
          const url = isEditMode ? `/api/karyawan/${nik}` : "/api/karyawan";

          $.ajax({
            url: url,
            method: method,
            contentType: "application/json",
            data: JSON.stringify(formData),
            xhrFields: { withCredentials: true },
            success: function (response) {
              employeeModal.hide();
              loadProfile(); // Reload profile to refresh employees
            },
            error: function (xhr) {
              console.error("Save employee error:", xhr);
              alert(
                "Failed to save employee: " +
                  (xhr.responseJSON?.message || "Unknown error")
              );
            },
          });
        });

        // Delete Employee Handler
        $(document).on("click", ".delete-employee", function () {
          const nik = $(this).data("nik");

          // Show delete confirmation modal
          deleteConfirmModal.show();

          $("#confirmDeleteBtn")
            .off("click")
            .on("click", function () {
              $.ajax({
                url: `/api/karyawan/${nik}`,
                method: "DELETE",
                xhrFields: { withCredentials: true },
                success: function () {
                  deleteConfirmModal.hide();
                  loadProfile(); // Reload entire profile to refresh employees
                },
                error: function (xhr) {
                  console.error("Delete employee error:", xhr);
                  alert("Failed to delete employee. Please try again.");
                },
              });
            });
        });

        // Logout Handler
        $("#logoutBtn").on("click", function () {
          $.ajax({
            url: "/api/users/logout",
            method: "POST",
            xhrFields: { withCredentials: true },
            success: function () {
              window.location.href = "/login";
            },
            error: function () {
              alert("Logout failed. Please try again.");
            },
          });
        });
      });
    </script>
  </body>
</html>
